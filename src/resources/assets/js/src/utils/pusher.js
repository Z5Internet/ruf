"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_http=require("./http"),_http2=_interopRequireDefault(_http),_reduxConnect=require("./redux-connect"),_reduxConnect2=_interopRequireDefault(_reduxConnect),Pusher=function(e){function t(e,r){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n.store=r.store,n.state={lastPusherUpdate:0,lastIdFetched:0,stop:!1},n}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){this.store.dispatch({type:"STORE_USER",user:{pusherId:(new Date).getTime()}}),this.startPoll(0)}},{key:"componentWillReceiveProps",value:function(e){e.push.lastPusherUpdate!=this.state.lastPusherUpdate&&this.restart(e.push.lastPusherUpdate),this.state.lastPusherUpdate=e.push.lastPusherUpdate}},{key:"componentWillUnmount",value:function(){this.state.stop=!0}},{key:"startPoll",value:function(e){this.restart(e)}},{key:"getChannelData",value:function(e){var t=this;e||(e=this.props.push);var r={};return Object.keys(e).map(function(n){if("lastPusherUpdate"!=n){if(r[n]=e[n],"u"==n)return void(r.u=t.getChannelData(e.u));var s=e[n];s&&s.constructor&&s.call&&s.apply&&(s=s()),r[n]=s}}),r}},{key:"poll",value:function(){var e=this,t=this,r=this.getChannelData();0==Object.keys(r).length||1==Object.keys(r).length&&r.u&&0==Object.keys(r.u).length||this.state.stop||(this.store.dispatch({type:"STORE_USER",user:{pusherConnId:(new Date).getTime()}}),_http2.default.post("/data/push",{c:r,l:this.state.lastIdFetched}).then(function(r){r.l&&e.setState({lastIdFetched:r.l}),r.stop||(r.c&&Object.keys(r.c).map(function(t){"u"==t?Object.keys(r.c.u).map(function(t){e.props.push.u[t]&&e.props.pusherCallbacks.u[t](r.c.u[t])}):e.props.push[t]&&e.props.pusherCallbacks[t](r.c[t])}),t.poll())}).catch(function(e){t.delayedStart()}))}},{key:"delayedStart",value:function(){setTimeout(this.poll.bind(this),2e3)}},{key:"restart",value:function(e){setTimeout(function(e){e==this.state.lastPusherUpdate&&this.poll()}.bind(this,e),200)}},{key:"render",value:function(){return _react2.default.createElement("span",null)}}]),t}(_react.Component);module.exports=(0,_reduxConnect2.default)(Pusher,{user:"user",push:"push",pusherCallbacks:"pusherCallbacks"});