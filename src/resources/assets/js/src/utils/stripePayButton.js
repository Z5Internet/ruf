"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_reduxConnect=require("./redux-connect"),_reduxConnect2=_interopRequireDefault(_reduxConnect),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),_http=require("rufUtils/http"),_http2=_interopRequireDefault(_http),_reactRouterDom=require("react-router-dom"),_alert=require("rufUtils/modals/alert"),_alert2=_interopRequireDefault(_alert),_modal=require("rufUtils/modals/modal"),_modal2=_interopRequireDefault(_modal),_scriptjs=require("scriptjs"),_scriptjs2=_interopRequireDefault(_scriptjs),StripePayButton=function(e){function t(e,r){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={stripeLoaded:!1},n.store=r.store,n}return _inherits(t,e),_createClass(t,[{key:"componentWillUnmount",value:function(){this.unmounted=!0}},{key:"buy",value:function(){var e=this;(0,_alert2.default)("1m","","One moment",!1);var t=this;(0,_scriptjs2.default)("https://checkout.stripe.com/checkout.js",function(){t.setState({stripeLoaded:!0})});this.props.user.currentTeam.id;_http2.default.post("/data/payment/addProduct/"+this.props.productId).then(function(t){switch(t.result){case"success":return void _http2.default.get("/data/start").then(function(t){e.store.dispatch({type:"STORE_USER",user:t.user}),_modal2.default.close("1m"),e.stripeReturn()});case"alreadySubscribed":e.stripeReturn();break;case"requiresPaymentInfo":e.launchStripe(e.buy.bind(e));break;case"failed":(0,_alert2.default)("payment error","Error","There was an error with your payment.");break;case"No product":(0,_alert2.default)("no product error","Error","Product "+e.props.productId+" doesn't exist")}_modal2.default.close("1m")})}},{key:"launchStripe",value:function(e){if(!this.state.stripeLoaded)return void setTimeout(this.launchStripe.bind(this,e),500);this.stripeHandler(e).open({name:this.props.website.name,description:"",panelLabel:"Use this card"})}},{key:"stripeReturn",value:function(){this.props.history.push(this.props.returnURL)}},{key:"stripeHandler",value:function(e){return this.sth?this.sth:(this.sth=StripeCheckout.configure({key:this.props.website.stripe_key,image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",email:this.props.user.email,token:function(t){_http2.default.post("/data/payment/stripe/token",{token:t}).then(function(t){e(t)})}}),this.sth)}},{key:"render",value:function(){return _react2.default.createElement("button",{className:(0,_classnames2.default)("btn",this.props.className),onClick:this.buy.bind(this)},this.props.buttonText)}}]),t}(_react.Component);module.exports=(0,_reactRouterDom.withRouter)((0,_reduxConnect2.default)(StripePayButton,{user:"user",website:"website"}));