"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_http=require("rufUtils/http"),_http2=_interopRequireDefault(_http),_gender=require("rufUtils/gender"),_gender2=_interopRequireDefault(_gender),_reduxConnect=require("rufUtils/redux-connect"),_reduxConnect2=_interopRequireDefault(_reduxConnect),_ProfilePic=require("../Auth/Settings/ProfilePic"),_ProfilePic2=_interopRequireDefault(_ProfilePic),_Loading=require("rufUtils/Loading"),_Loading2=_interopRequireDefault(_Loading),Setup=function(e){function t(e,a){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,a)),s=new URLSearchParams(e.location.search);return r.state={step:0,setupData:{first_name:"",last_name:"",gender:"",password1:"",password2:"",username:"",id:s.get("id"),code:s.get("code")},buttons:{prev:0,next:0},errorMessage:"",checkingUsername:"",creatingAccount:"",usernameRequired:null,uploadProfilePic:null},r}return _inherits(t,e),_createClass(t,[{key:"gotoGetstarted",value:function(){this.props.history.push("/getStarted")}},{key:"componentDidMount",value:function(){var e=this;_http2.default.get("/data/setup?id="+this.state.setupData.id+"&code="+this.state.setupData.code).then(function(t){if(t.setup){if(t.setup.existingUser)return void e.props.history.push("/SetupExistingUser?id="+e.state.setupData.id+"&code="+e.state.setupData.code);t.setup.first_name?(e.state.setupData.first_name=t.setup.first_name,e.state.setupData.team=t.setup.team,e.state.uploadProfilePic=t.setup.uploadProfilePic,e.state.usernameRequired=t.setup.usernameRequired,e.state.teamToJoin=t.setup.teamToJoin,e.state.invited=t.setup.invited,e.changeStep("next")):e.props.user&&e.props.user.id?e.gotoGetstarted():e.changeStep("prev")}else e.props.history.replace("/home")})}},{key:"changeStep",value:function(e){if("prev"==e||this.verifyStep()){var t=0;"prev"==e&&(t=-1),"next"==e&&(t=1);var a=this.state.step+t;4!=a||this.state.usernameRequired||(a+=t),5!=a||this.props.website.multiAccounts&&!this.state.setupData.team&&!this.state.invited||(a+=t),7!=a||this.state.uploadProfilePic||(a+=t),this.setState({step:a}),this.state.step=a,this.setController()}}},{key:"verifyStep",value:function(){switch(this.state.step){case 2:if(!this.state.setupData.first_name||!this.state.setupData.last_name)return this.setState({errorMessage:"You need to type in both your first and last names."}),!1;if(!_gender2.default[this.state.setupData.gender])return this.setState({errorMessage:"You need to select your gender."}),!1;break;case 3:if(!this.state.setupData.password1||this.state.setupData.password1!=this.state.setupData.password2)return this.setState({errorMessage:"You need to type your password in both boxes. The passwords you have typed into each box do not match."}),!1;if(this.state.setupData.password1.length<6)return this.setState({errorMessage:"Your password must be at least 6 letters long."}),!1;break;case 5:if(!this.state.setupData.teamName)return this.setState({errorMessage:"You need to enter your "+this.props.website.multiAccounts.label+" name"}),!1}return!0}},{key:"setController",value:function(){var e=[!1,!1];switch(this.setState({errorMessage:""}),this.state.step){case 1:case 2:e[1]=!0;break;case 3:e=[!0,!0];break;case 4:e=[!0];break;case 5:e=[!0,!0];break;case 6:this.setState({showPassword:new Array(this.state.setupData.password1.length+1).join("*")}),e=[!0]}this.setState({buttons:{prev:e[0],next:e[1]}})}},{key:"changeData",value:function(e,t){var a=this.state.setupData;"gender"==e?a.gender=t:a[e]=this.refs[e].value,this.setState(a)}},{key:"checkUsername",value:function(e){var t=this,a=this.state.setupData.username;a&&(a.match(/[^0-9a-zA-Z]/)?this.setState({errorMessage:"Your username can only contain the letters a-z and the numbers 0-9."}):a.length>=6?(this.setState({checkingUsername:!0}),_http2.default.post("/data/setup/checkusername",{username:a}).then(function(e){t.setState({checkingUsername:!1}),e.setup&&(e.setup.usernameOK?t.changeStep("next"):t.setState({errorMessage:e.setup.usernameError}))})):this.setState({errorMessage:"Your username must be at least 6 letters long."})),e.preventDefault()}},{key:"completeSetup",value:function(){var e=this;this.setState({creatingAccount:!0}),_http2.default.post("/data/setup",this.state.setupData).then(function(t){t.setup.team?(e.context.store.dispatch({type:"STORE_USER",user:{currentTeam:{id:t.setup.team}}}),_http2.default.get("/data/start").then(function(t){e.setState({creatingAccount:!1}),e.context.store.dispatch({type:"STORE_USER",user:t.user}),e.changeStep("next")})):e.setState({errorMessage:t.setup.error,creatingAccount:!1})})}},{key:"render",value:function(){var e=void 0;switch(this.state.step){case 0:e=_react2.default.createElement("div",{className:"text-center"},_react2.default.createElement("h1",null,"Checking your verification link"),_react2.default.createElement(_Loading2.default,null));break;case-1:e=_react2.default.createElement("div",{className:"text-center"},_react2.default.createElement("h2",{className:"red"},"This is not a valid verification link."),"This is probably because you've already validated your email address, or it could be because you haven't typed the link in correctly.");break;case 1:e=_react2.default.createElement("div",{className:"text-center"},_react2.default.createElement("h2",{className:"red"},"Verification link accepted."),"You are 3 steps and 1 minute away from setting up your ",this.props.website.name,'  account. Click on the "Next" button to get started.');break;case 2:e=_react2.default.createElement("div",null,_react2.default.createElement("h2",null,"Setup"),"First, enter your name and gender below.",_react2.default.createElement("br",null),_react2.default.createElement("br",null),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("label",{className:"col-md-4 col-form-label"},"First name"),_react2.default.createElement("div",{className:"col-md-8"},_react2.default.createElement("input",{className:"form-control",type:"text",ref:"first_name",defaultValue:this.state.setupData.first_name,onChange:this.changeData.bind(this,"first_name"),placeholder:"Your first name"}))),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("label",{className:"col-md-4 col-form-label"},"Last name"),_react2.default.createElement("div",{className:"col-md-8"},_react2.default.createElement("input",{className:"form-control",type:"text",ref:"last_name",defaultValue:this.state.setupData.last_name,onChange:this.changeData.bind(this,"last_name"),placeholder:"Your last name"}))),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("label",{className:"col-md-4 col-form-label"},"Gender"),_gender2.default.map(function(e,t,a){return _react2.default.createElement("div",{key:t,className:"col-6 col-md-3 text-center"},_react2.default.createElement("label",null,e.name,_react2.default.createElement("br",null),_react2.default.createElement("input",{name:"gender",type:"radio",onClick:this.changeData.bind(this,"gender",t),defaultChecked:this.state.setupData.gender===t})))},this)));break;case 3:e=_react2.default.createElement("div",null,_react2.default.createElement("h2",null,"Choose a password"),_react2.default.createElement("div",{className:"row form-group"},"Now choose a password that you want to use when you login. Type your password in twice. Your password is case sensitive so be careful with capital letters."),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("label",{className:"col-md-4 col-form-label"},"Type your password"),_react2.default.createElement("div",{className:"col-md-8"},_react2.default.createElement("input",{className:"form-control",type:"password",ref:"password1",defaultValue:this.state.setupData.password1,onChange:this.changeData.bind(this,"password1"),placeholder:"Type your password"}))),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("label",{className:"col-md-4 col-form-label"},"Retype your password"),_react2.default.createElement("div",{className:"col-md-8"},_react2.default.createElement("input",{className:"form-control",type:"password",ref:"password2",defaultValue:this.state.setupData.password2,onChange:this.changeData.bind(this,"password2"),placeholder:"Retype your password"}))));break;case 4:e=_react2.default.createElement("div",null,_react2.default.createElement("h2",null,"Choose a username"),_react2.default.createElement("div",{className:"text-center row form-group"},"Your username must be at least 6 characters long and can only contain the letters A to Z and the numbers 0 to 9.",_react2.default.createElement("br",null),_react2.default.createElement("br",null),_react2.default.createElement("b",null,"Type your username in the box below.")),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("div",{className:"col-md-12"},_react2.default.createElement("input",{className:"form-control",type:"text",ref:"username",defaultValue:this.state.setupData.username,onChange:this.changeData.bind(this,"username"),placeholder:"Type a username"}))),_react2.default.createElement("div",{className:"text-center"},_react2.default.createElement("button",{type:"submit",className:"btn btn-primary",disabled:this.state.checkingUsername,onClick:this.checkUsername.bind(this)},_react2.default.createElement("span",null,"Check username"))));break;case 5:e=_react2.default.createElement("div",null,_react2.default.createElement("h2",null,"Your ",this.props.website.multiAccounts.label," name"),_react2.default.createElement("div",{className:"row form-group"},_react2.default.createElement("label",{className:"col-md-4 col-form-label"},"Type your ",this.props.website.multiAccounts.label," name"),_react2.default.createElement("div",{className:"col-md-8"},_react2.default.createElement("input",{className:"form-control",type:"text",ref:"teamName",defaultValue:this.state.setupData.teamName,onChange:this.changeData.bind(this,"teamName"),placeholder:"Type your "+this.props.website.multiAccounts.label+" name"}))));break;case 6:e=_react2.default.createElement("div",{className:"clearfix"},_react2.default.createElement("h2",null,"Verify your information"),_react2.default.createElement("div",{className:"form-group"},'If the information below is correct, click "Create account".'),_react2.default.createElement("ul",{className:"list-group"},_react2.default.createElement("li",{className:"list-group-item"},_react2.default.createElement("h4",{className:"w-100 list-group-item-heading"},"First name"),_react2.default.createElement("p",{className:"mb-1 list-group-item-text"},this.state.setupData.first_name)),_react2.default.createElement("li",{className:"list-group-item"},_react2.default.createElement("h4",{className:"w-100 list-group-item-heading"},"Last name"),_react2.default.createElement("p",{className:"mb-1 list-group-item-text"},this.state.setupData.last_name)),_react2.default.createElement("li",{className:"list-group-item"},_react2.default.createElement("h4",{className:"w-100 list-group-item-heading"},"Password"),_react2.default.createElement("p",{className:"mb-1 list-group-item-text"},this.state.showPassword)),this.state.usernameRequired?_react2.default.createElement("li",{className:"list-group-item"},_react2.default.createElement("h4",{className:"w-100 list-group-item-heading"},"Username"),_react2.default.createElement("p",{className:"mb-1 list-group-item-text"},this.state.setupData.username)):"",_react2.default.createElement("li",{className:"list-group-item"},_react2.default.createElement("h4",{className:"w-100 list-group-item-heading"},"Gender"),_react2.default.createElement("p",{className:"mb-1 list-group-item-text"},_gender2.default[this.state.setupData.gender].name)),this.state.setupData.team||!this.props.website.multiAccounts||!this.props.website.multiAccounts.label||this.state.invited?"":_react2.default.createElement("li",{className:"list-group-item"},_react2.default.createElement("h4",{className:"w-100 list-group-item-heading"},this.props.website.multiAccounts.label," name"),_react2.default.createElement("p",{className:"mb-1 list-group-item-text"},this.state.setupData.teamName))),_react2.default.createElement("br",null),_react2.default.createElement("button",{className:"btn btn-primary",disabled:this.state.creatingAccount,onClick:this.completeSetup.bind(this),style:{float:"right",marginTop:"20px"}},"Create account"));break;case 7:e=_react2.default.createElement("div",null,_react2.default.createElement("div",{className:"row"},_react2.default.createElement("div",{className:"col-12",style:{marginBottom:"20px"}},_react2.default.createElement("h2",null,"Upload a profile pic"),'If you want to upload a profile pic now you can do that below. If you\'re not ready to upload a profile pic, click on "Skip".')),_react2.default.createElement(_ProfilePic2.default,{finished:this.gotoGetstarted.bind(this)}),_react2.default.createElement("button",{className:"btn btn-primary float-right",onClick:this.gotoGetstarted.bind(this)},"Skip"))}return _react2.default.createElement("div",{className:"container"},_react2.default.createElement("div",{style:{maxWidth:"600px",margin:"0 auto 30px"}},e,_react2.default.createElement("div",{className:"row",style:{marginTop:"20px"}},this.state.errorMessage?_react2.default.createElement("div",{className:"red col-12",style:{fontWeight:"bolder",textAlign:"center",marginBottom:"18px"}},this.state.errorMessage):"",_react2.default.createElement("div",{className:"col-6 text-center"},this.state.buttons.prev?_react2.default.createElement("button",{disabled:this.state.creatingAccount,className:"btn btn-primary",onClick:this.changeStep.bind(this,"prev")},"Prev"):""),_react2.default.createElement("div",{className:"col-6 text-center"},this.state.buttons.next?_react2.default.createElement("button",{className:"btn btn-primary",onClick:this.changeStep.bind(this,"next")},"Next"):""))))}}]),t}(_react.Component);module.exports=(0,_reduxConnect2.default)(Setup,{website:"website",user:"user"});